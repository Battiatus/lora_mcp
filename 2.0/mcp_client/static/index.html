<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP Advanced Assistant</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    <!-- <link rel="stylesheet" href="style/styles.css"> -->
</head>
<body>
<style>
/* Reset and base styles */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

:root {
    --primary-color: #2563eb;
    --primary-hover: #1d4ed8;
    --secondary-color: #64748b;
    --success-color: #10b981;
    --warning-color: #f59e0b;
    --error-color: #ef4444;
    --background: #f8fafc;
    --surface: #ffffff;
    --surface-hover: #f1f5f9;
    --border: #e2e8f0;
    --text-primary: #1e293b;
    --text-secondary: #64748b;
    --text-muted: #94a3b8;
    --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
    --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
    --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    --border-radius: 8px;
    --transition: all 0.2s ease-in-out;
}

body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background-color: var(--background);
    color: var(--text-primary);
    line-height: 1.6;
    overflow-x: hidden;
}

/* Login Styles */
.login-container {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, var(--primary-color) 0%, #3b82f6 100%);
    padding: 20px;
}

.login-card {
    background: var(--surface);
    border-radius: 16px;
    padding: 40px;
    box-shadow: var(--shadow-lg);
    width: 100%;
    max-width: 400px;
    animation: slideUp 0.5s ease-out;
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.login-header {
    text-align: center;
    margin-bottom: 30px;
}

.login-header .logo {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    margin-bottom: 16px;
}

.login-header .logo i {
    font-size: 32px;
    color: var(--primary-color);
}

.login-header h1 {
    font-size: 28px;
    font-weight: 700;
    color: var(--text-primary);
}

.login-header p {
    color: var(--text-secondary);
    margin-top: 8px;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: var(--text-primary);
}

.form-group input {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid var(--border);
    border-radius: var(--border-radius);
    font-size: 16px;
    transition: var(--transition);
    background: var(--surface);
}

.form-group input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgb(37 99 235 / 0.1);
}

.login-btn {
    width: 100%;
    padding: 12px 16px;
    background: var(--primary-color);
    color: white;
    border: none;
    border-radius: var(--border-radius);
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.login-btn:hover {
    background: var(--primary-hover);
    transform: translateY(-1px);
}

.login-error {
    margin-top: 16px;
    padding: 12px;
    background: #fef2f2;
    border: 1px solid #fecaca;
    border-radius: var(--border-radius);
    color: var(--error-color);
    font-size: 14px;
    display: none;
}

/* App Layout */
.app-container {
    height: 100vh;
    display: flex;
    flex-direction: column;
    background: var(--background);
}

/* Header */
.app-header {
    height: 64px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 24px;
    box-shadow: var(--shadow-sm);
    z-index: 1000;
}

.header-left {
    display: flex;
    align-items: center;
    gap: 16px;
}

.sidebar-toggle {
    background: none;
    border: none;
    padding: 8px;
    border-radius: var(--border-radius);
    cursor: pointer;
    color: var(--text-secondary);
    transition: var(--transition);
}

.sidebar-toggle:hover {
    background: var(--surface-hover);
    color: var(--text-primary);
}

.logo {
    display: flex;
    align-items: center;
    gap: 12px;
    font-weight: 600;
    color: var(--primary-color);
}

.logo i {
    font-size: 24px;
}

.header-center h1 {
    font-size: 20px;
    font-weight: 600;
    color: var(--text-primary);
}

.header-right {
    display: flex;
    align-items: center;
    gap: 16px;
}

.api-limits {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    background: var(--surface-hover);
    border-radius: var(--border-radius);
    font-size: 14px;
    color: var(--text-secondary);
}

.user-menu {
    position: relative;
}

.user-avatar {
    background: none;
    border: none;
    cursor: pointer;
    border-radius: 50%;
    overflow: hidden;
    width: 40px;
    height: 40px;
}

.user-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.user-dropdown {
    position: absolute;
    top: 100%;
    right: 0;
    margin-top: 8px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-lg);
    min-width: 200px;
    z-index: 1000;
    display: none;
}

.user-dropdown.show {
    display: block;
    animation: slideDown 0.2s ease-out;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.user-info {
    padding: 16px;
    display: flex;
    align-items: center;
    gap: 12px;
}

.user-info img {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    object-fit: cover;
}

.dropdown-divider {
    height: 1px;
    background: var(--border);
    margin: 8px 0;
}

.dropdown-item {
    width: 100%;
    padding: 12px 16px;
    background: none;
    border: none;
    text-align: left;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    gap: 12px;
    color: var(--text-primary);
}

.dropdown-item:hover {
    background: var(--surface-hover);
}

/* App Body */
.app-body {
    flex: 1;
    display: flex;
    overflow: hidden;
}

/* Sidebar */
.sidebar {
    width: 320px;
    background: var(--surface);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    transition: var(--transition);
    overflow: hidden;
}

.sidebar.collapsed {
    width: 0;
    min-width: 0;
}

.sidebar-header {
    padding: 20px;
    border-bottom: 1px solid var(--border);
}

.new-chat-btn {
    width: 100%;
    padding: 12px 16px;
    background: var(--primary-color);
    color: white;
    border: none;
    border-radius: var(--border-radius);
    font-weight: 500;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    margin-bottom: 16px;
}

.new-chat-btn:hover {
    background: var(--primary-hover);
}

.status-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    color: var(--text-secondary);
}

.status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--success-color);
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.sidebar-content {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
}

.conversations-section h3,
.mode-selector + .quick-actions h3,
.examples-section h3 {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: 12px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.conversations-list {
    margin-bottom: 24px;
}

.conversation-item {
    padding: 12px;
    border-radius: var(--border-radius);
    cursor: pointer;
    transition: var(--transition);
    margin-bottom: 4px;
    border: 1px solid transparent;
}

.conversation-item:hover {
    background: var(--surface-hover);
    border-color: var(--border);
}

.conversation-item.active {
    background: var(--primary-color);
    color: white;
}

.conversation-title {
    font-weight: 500;
    margin-bottom: 4px;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.conversation-date {
    font-size: 12px;
    opacity: 0.7;
}

.sidebar-divider {
    height: 1px;
    background: var(--border);
    margin: 20px 0;
}

.mode-selector {
    display: flex;
    gap: 8px;
    margin-bottom: 24px;
}

.mode-btn {
    flex: 1;
    padding: 12px;
    background: var(--surface-hover);
    border: 1px solid var(--border);
    border-radius: var(--border-radius);
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    font-size: 12px;
    color: var(--text-secondary);
}

.mode-btn.active {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}

.mode-btn i {
    font-size: 16px;
}

.action-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-bottom: 24px;
}

.action-btn {
    padding: 12px;
    background: var(--surface-hover);
    border: 1px solid var(--border);
    border-radius: var(--border-radius);
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    font-size: 12px;
    color: var(--text-secondary);
}

.action-btn:hover {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}

.examples-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.example-item {
    padding: 12px;
    background: var(--surface-hover);
    border: 1px solid var(--border);
    border-radius: var(--border-radius);
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: flex-start;
    gap: 12px;
}

.example-item:hover {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}

.example-item i {
    font-size: 16px;
    margin-top: 2px;
    flex-shrink: 0;
}

.example-item span {
    font-size: 14px;
    line-height: 1.4;
}

/* Main Content */
.main-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

/* Progress Bar */
.progress-container {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 16px 24px;
}

.progress-bar {
    width: 100%;
    height: 6px;
    background: var(--border);
    border-radius: 3px;
    overflow: hidden;
    margin-bottom: 12px;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--primary-color), #3b82f6);
    border-radius: 3px;
    transition: width 0.3s ease;
    width: 0%;
}

.progress-info {
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.progress-details-btn {
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 4px;
    border-radius: var(--border-radius);
    transition: var(--transition);
}

.progress-details-btn:hover {
    background: var(--surface-hover);
    color: var(--primary-color);
}

/* Chat Container */
.chat-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.messages-container {
    flex: 1;
    overflow-y: auto;
    padding: 24px;
    scroll-behavior: smooth;
}

/* Welcome Message */
.welcome-message {
    text-align: center;
    max-width: 600px;
    margin: 0 auto;
    padding: 60px 20px;
}

.welcome-icon {
    width: 80px;
    height: 80px;
    background: linear-gradient(135deg, var(--primary-color), #3b82f6);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 24px;
}

.welcome-icon i {
    font-size: 32px;
    color: white;
}

.welcome-message h2 {
    font-size: 32px;
    font-weight: 700;
    margin-bottom: 16px;
    color: var(--text-primary);
}

.welcome-message p {
    font-size: 18px;
    color: var(--text-secondary);
    margin-bottom: 32px;
}

.welcome-features {
    display: flex;
    justify-content: center;
    gap: 32px;
    flex-wrap: wrap;
}

.feature {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    padding: 20px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--border-radius);
    transition: var(--transition);
}

.feature:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow);
}

.feature i {
    font-size: 24px;
    color: var(--primary-color);
}

/* Messages */
.message {
    margin-bottom: 24px;
    animation: fadeInUp 0.3s ease-out;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.message-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 8px;
}

.message-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: 600;
}

.message.user .message-avatar {
    background: var(--primary-color);
    color: white;
}

.message.assistant .message-avatar {
    background: var(--success-color);
    color: white;
}

.message.system .message-avatar {
    background: var(--warning-color);
    color: white;
}

.message-info {
    flex: 1;
}

.message-sender {
    font-weight: 600;
    color: var(--text-primary);
}

.message-time {
    font-size: 12px;
    color: var(--text-muted);
}

.message-content {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--border-radius);
    padding: 16px;
    margin-left: 44px;
    position: relative;
}

.message.user .message-content {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}

.message-content::before {
    content: '';
    position: absolute;
    top: 12px;
    left: -8px;
    width: 0;
    height: 0;
    border-top: 8px solid transparent;
    border-bottom: 8px solid transparent;
    border-right: 8px solid var(--surface);
}

.message.user .message-content::before {
    border-right-color: var(--primary-color);
}

/* Markdown content styling */
.message-content h1,
.message-content h2,
.message-content h3,
.message-content h4,
.message-content h5,
.message-content h6 {
    margin: 16px 0 8px 0;
    font-weight: 600;
}

.message-content h1 { font-size: 24px; }
.message-content h2 { font-size: 20px; }
.message-content h3 { font-size: 18px; }
.message-content h4 { font-size: 16px; }

.message-content p {
    margin: 8px 0;
    line-height: 1.6;
}

.message-content ul,
.message-content ol {
    margin: 8px 0;
    padding-left: 24px;
}

.message-content li {
    margin: 4px 0;
}

.message-content pre {
    background: #1e1e1e;
    color: #d4d4d4;
    padding: 16px;
    border-radius: var(--border-radius);
    overflow-x: auto;
    margin: 12px 0;
    font-family: 'Fira Code', 'Consolas', monospace;
}

.message-content code {
    background: rgba(0, 0, 0, 0.1);
    padding: 2px 6px;
    border-radius: 4px;
    font-family: 'Fira Code', 'Consolas', monospace;
    font-size: 14px;
}

.message-content pre code {
    background: none;
    padding: 0;
}

.message-content blockquote {
    border-left: 4px solid var(--primary-color);
    padding-left: 16px;
    margin: 12px 0;
    font-style: italic;
    opacity: 0.8;
}

.message-content table {
    width: 100%;
    border-collapse: collapse;
    margin: 12px 0;
}

.message-content th,
.message-content td {
    padding: 8px 12px;
    text-align: left;
    border-bottom: 1px solid var(--border);
}

.message-content th {
    background: var(--surface-hover);
    font-weight: 600;
}

/* Tool execution indicators */
.tool-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    background: var(--surface-hover);
    border-radius: var(--border-radius);
    margin: 8px 0;
    font-size: 14px;
}

.tool-indicator.executing {
    color: var(--warning-color);
}

.tool-indicator.success {
    color: var(--success-color);
}

.tool-indicator.error {
    color: var(--error-color);
}

.tool-indicator i {
    animation: spin 1s linear infinite;
}

.tool-indicator.success i,
.tool-indicator.error i {
    animation: none;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* Message actions */
.message-actions {
    display: flex;
    gap: 8px;
    margin-top: 12px;
    opacity: 0;
    transition: var(--transition);
}

.message:hover .message-actions {
    opacity: 1;
}

.message-action {
    background: none;
    border: 1px solid var(--border);
    border-radius: var(--border-radius);
    padding: 6px 12px;
    font-size: 12px;
    cursor: pointer;
    transition: var(--transition);
    color: var(--text-secondary);
}

.message-action:hover {
    background: var(--surface-hover);
    color: var(--text-primary);
}

/* Result preview */
.result-preview {
    max-height: 300px;
    overflow: hidden;
    position: relative;
}

.result-preview.truncated::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 40px;
    background: linear-gradient(transparent, var(--surface));
}

.show-more-btn {
    margin-top: 12px;
    background: var(--primary-color);
    color: white;
    border: none;
    border-radius: var(--border-radius);
    padding: 8px 16px;
    cursor: pointer;
    transition: var(--transition);
}

.show-more-btn:hover {
    background: var(--primary-hover);
}

/* Screenshots gallery */
.screenshots-summary {
    margin-top: 16px;
    padding: 16px;
    background: var(--surface-hover);
    border-radius: var(--border-radius);
}

.screenshots-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 12px;
    margin-top: 12px;
}

.screenshot-thumb {
    aspect-ratio: 16/9;
    background: var(--border);
    border-radius: var(--border-radius);
    overflow: hidden;
    cursor: pointer;
    transition: var(--transition);
}

.screenshot-thumb:hover {
    transform: scale(1.05);
    box-shadow: var(--shadow);
}

.screenshot-thumb img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* Input Container */
.input-container {
    background: var(--surface);
    border-top: 1px solid var(--border);
    padding: 20px 24px;
}

.input-wrapper {
    display: flex;
    align-items: flex-end;
    gap: 12px;
    background: var(--surface);
    border: 2px solid var(--border);
    border-radius: 12px;
    padding: 12px;
    transition: var(--transition);
}

.input-wrapper:focus-within {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgb(37 99 235 / 0.1);
}

#messageInput {
    flex: 1;
    border: none;
    outline: none;
    resize: none;
    font-family: inherit;
    font-size: 16px;
    line-height: 1.5;
    background: transparent;
    color: var(--text-primary);
    max-height: 120px;
}

#messageInput::placeholder {
    color: var(--text-muted);
}

.input-actions {
    display: flex;
    gap: 8px;
}

.action-btn-small {
    width: 36px;
    height: 36px;
    background: none;
    border: none;
    border-radius: var(--border-radius);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: var(--transition);
    color: var(--text-secondary);
}

.action-btn-small:hover {
    background: var(--surface-hover);
    color: var(--text-primary);
}

.send-btn {
    width: 36px;
    height: 36px;
    background: var(--primary-color);
    border: none;
    border-radius: var(--border-radius);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: var(--transition);
    color: white;
}

.send-btn:hover {
    background: var(--primary-hover);
    transform: translateY(-1px);
}

.send-btn:disabled {
    background: var(--text-muted);
    cursor: not-allowed;
    transform: none;
}

.send-btn.stop {
    background: var(--error-color);
}

.send-btn.stop:hover {
    background: #dc2626;
}

.input-footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-top: 12px;
}

.input-hint {
    font-size: 12px;
    color: var(--text-muted);
}

.typing-indicator {
    display: none;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    color: var(--text-secondary);
}

.typing-indicator.show {
    display: flex;
}

.typing-dots {
    display: flex;
    gap: 4px;
}

.typing-dots span {
    width: 6px;
    height: 6px;
    background: var(--primary-color);
    border-radius: 50%;
    animation: typing 1.4s ease-in-out infinite;
}

.typing-dots span:nth-child(2) {
    animation-delay: 0.2s;
}

.typing-dots span:nth-child(3) {
    animation-delay: 0.4s;
}

@keyframes typing {
    0%, 60%, 100% {
        transform: translateY(0);
    }
    30% {
        transform: translateY(-10px);
    }
}

/* Modals */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 2000;
    padding: 20px;
}

.modal-overlay.show {
    display: flex;
    animation: fadeIn 0.2s ease-out;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.modal {
    background: var(--surface);
    border-radius: 12px;
    box-shadow: var(--shadow-lg);
    max-width: 600px;
    width: 100%;
    max-height: 80vh;
    display: flex;
    flex-direction: column;
    animation: slideUp 0.3s ease-out;
}

.modal.large {
    max-width: 90vw;
    max-height: 90vh;
}

.modal-header {
    padding: 20px 24px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.modal-header h3 {
    font-size: 18px;
    font-weight: 600;
    color: var(--text-primary);
}

.modal-actions {
    display: flex;
    gap: 12px;
}

.modal-close {
    background: none;
    border: none;
    width: 32px;
    height: 32px;
    border-radius: var(--border-radius);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: var(--transition);
    color: var(--text-secondary);
}

.modal-close:hover {
    background: var(--surface-hover);
    color: var(--text-primary);
}

.modal-content {
    flex: 1;
    padding: 24px;
    overflow-y: auto;
}

/* Export options */
.export-options {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 16px;
}

.export-btn {
    padding: 20px;
    background: var(--surface-hover);
    border: 2px solid var(--border);
    border-radius: var(--border-radius);
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    text-align: center;
}

.export-btn:hover {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
    transform: translateY(-2px);
}

.export-btn i {
    font-size: 24px;
}

/* Buttons */
.btn-primary {
    background: var(--primary-color);
    color: white;
    border: none;
    border-radius: var(--border-radius);
    padding: 8px 16px;
    cursor: pointer;
    transition: var(--transition);
    font-weight: 500;
}

.btn-primary:hover {
    background: var(--primary-hover);
}

.btn-secondary {
    background: var(--surface-hover);
    color: var(--text-primary);
    border: 1px solid var(--border);
    border-radius: var(--border-radius);
    padding: 8px 16px;
    cursor: pointer;
    transition: var(--transition);
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 8px;
}

.btn-secondary:hover {
    background: var(--border);
}

/* Responsive Design */
@media (max-width: 1024px) {
    .sidebar {
        width: 280px;
    }
    
    .welcome-features {
        gap: 16px;
    }
    
    .feature {
        padding: 16px;
    }
}

@media (max-width: 768px) {
    .app-header {
        padding: 0 16px;
    }
    
    .header-center h1 {
        display: none;
    }
    
    .sidebar {
        position: fixed;
        top: 64px;
        left: 0;
        bottom: 0;
        z-index: 1000;
        transform: translateX(-100%);
        width: 280px;
    }
    
    .sidebar.show {
        transform: translateX(0);
    }
    
    .main-content {
        width: 100%;
    }
    
    .messages-container {
        padding: 16px;
    }
    
    .input-container {
        padding: 16px;
    }
    
    .welcome-message {
        padding: 40px 16px;
    }
    
    .welcome-message h2 {
        font-size: 24px;
    }
    
    .welcome-features {
        flex-direction: column;
        gap: 12px;
    }
    
    .modal {
        margin: 20px;
        max-height: calc(100vh - 40px);
    }
    
    .action-grid {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 480px) {
    .login-card {
        padding: 24px;
    }
    
    .app-header {
        height: 56px;
        padding: 0 12px;
    }
    
    .logo span {
        display: none;
    }
    
    .sidebar {
        top: 56px;
        width: 100%;
    }
    
    .modal-content {
        padding: 16px;
    }
    
    .export-options {
        grid-template-columns: repeat(2, 1fr);
    }
}

/* Dark mode support */
@media (prefers-color-scheme: dark) {
    :root {
        --background: #0f172a;
        --surface: #1e293b;
        --surface-hover: #334155;
        --border: #475569;
        --text-primary: #f1f5f9;
        --text-secondary: #cbd5e1;
        --text-muted: #94a3b8;
    }
}

/* Loading states */
.loading {
    opacity: 0.6;
    pointer-events: none;
}

.loading::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 20px;
    height: 20px;
    margin: -10px 0 0 -10px;
    border: 2px solid var(--border);
    border-top-color: var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

/* Accessibility */
@media (prefers-reduced-motion: reduce) {
    * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
    }
}

/* Focus styles for keyboard navigation */
button:focus-visible,
input:focus-visible,
textarea:focus-visible {
    outline: 2px solid var(--primary-color);
    outline-offset: 2px;
}

/* High contrast mode support */
@media (prefers-contrast: high) {
    :root {
        --border: #000;
        --text-secondary: var(--text-primary);
    }
}
</style>

    <!-- Login Screen -->
    <div class="login-container" id="loginContainer">
        <div class="login-card">
            <div class="login-header">
                <div class="logo">
                    <i class="fas fa-robot"></i>
                    <h1>MCP Assistant</h1>
                </div>
                <p>Secure access to your AI assistant</p>
            </div>
            <form class="login-form" id="loginForm">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" name="username" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" required>
                </div>
                <button type="submit" class="login-btn">
                    <i class="fas fa-sign-in-alt"></i>
                    Sign In
                </button>
            </form>
            <div class="login-error" id="loginError"></div>
        </div>
    </div>

    <!-- Main App -->
    <div class="app-container" id="appContainer" style="display: none;">
        <!-- Header -->
        <header class="app-header">
            <div class="header-left">
                <button class="sidebar-toggle" id="sidebarToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="logo">
                    <i class="fas fa-robot"></i>
                    <span>MCP Assistant</span>
                </div>
            </div>
            <div class="header-center">
                <h1 id="chatTitle">Intelligent Web Assistant</h1>
            </div>
            <div class="header-right">
                <div class="api-limits" id="apiLimits">
                    <i class="fas fa-chart-line"></i>
                    <span id="remainingCalls">Loading...</span>
                </div>
                <div class="user-menu">
                    <button class="user-avatar" id="userAvatar">
                        <img src="/static/default-avatar.png" alt="User" id="avatarImg">
                    </button>
                    <div class="user-dropdown" id="userDropdown">
                        <div class="user-info">
                            <img src="/static/default-avatar.png" alt="User" id="dropdownAvatar">
                            <span id="username">User</span>
                        </div>
                        <div class="dropdown-divider"></div>
                        <button class="dropdown-item" id="changeAvatar">
                            <i class="fas fa-user-circle"></i>
                            Change Avatar
                        </button>
                        <button class="dropdown-item" id="exportData">
                            <i class="fas fa-download"></i>
                            Export Data
                        </button>
                        <button class="dropdown-item" id="logoutBtn">
                            <i class="fas fa-sign-out-alt"></i>
                            Logout
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <div class="app-body">
            <!-- Sidebar -->
            <aside class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <button class="new-chat-btn" id="newChatBtn">
                        <i class="fas fa-plus"></i>
                        New Conversation
                    </button>
                    <div class="status-indicator" id="connectionStatus">
                        <div class="status-dot"></div>
                        <span>Connecting...</span>
                    </div>
                </div>
                
                <div class="sidebar-content">
                    <!-- Conversations History -->
                    <div class="conversations-section">
                        <h3>Recent Conversations</h3>
                        <div class="conversations-list" id="conversationsList">
                            <!-- Conversations will be loaded here -->
                        </div>
                    </div>

                    <div class="sidebar-divider"></div>
                    
                    <!-- Mode Selector -->
                    <div class="mode-selector">
                        <button class="mode-btn active" data-mode="chat">
                            <i class="fas fa-comments"></i>
                            <span>Chat Mode</span>
                        </button>
                        <button class="mode-btn" data-mode="task">
                            <i class="fas fa-tasks"></i>
                            <span>Task Mode</span>
                        </button>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="quick-actions">
                        <h3>Quick Actions</h3>
                        <div class="action-grid">
                            <button class="action-btn" data-action="screenshot">
                                <i class="fas fa-camera"></i>
                                <span>Screenshot</span>
                            </button>
                            <button class="action-btn" data-action="navigate">
                                <i class="fas fa-globe"></i>
                                <span>Navigate</span>
                            </button>
                            <button class="action-btn" data-action="research">
                                <i class="fas fa-search"></i>
                                <span>Research</span>
                            </button>
                            <button class="action-btn" data-action="analyze">
                                <i class="fas fa-chart-line"></i>
                                <span>Analyze</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Examples -->
                    <div class="examples-section">
                        <h3>Example Commands</h3>
                        <div class="examples-list">
                            <div class="example-item" data-example="Research the latest AI trends and create a comprehensive report">
                                <i class="fas fa-brain"></i>
                                <span>AI Trends Research</span>
                            </div>
                            <div class="example-item" data-example="Navigate to news websites and analyze current events">
                                <i class="fas fa-newspaper"></i>
                                <span>News Analysis</span>
                            </div>
                            <div class="example-item" data-example="Take screenshots and document the user interface">
                                <i class="fas fa-desktop"></i>
                                <span>UI Documentation</span>
                            </div>
                        </div>
                    </div>
                </div>
            </aside>
            
            <!-- Main Content -->
            <main class="main-content">
                <!-- Progress Bar -->
                <div class="progress-container" id="progressContainer" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-info">
                        <span id="progressMessage">Processing...</span>
                        <button class="progress-details-btn" id="progressDetailsBtn">
                            <i class="fas fa-info-circle"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Chat Container -->
                <div class="chat-container">
                    <div class="messages-container" id="messagesContainer">
                        <div class="welcome-message" id="welcomeMessage">
                            <div class="welcome-icon">
                                <i class="fas fa-robot"></i>
                            </div>
                            <h2>Welcome to MCP Advanced Assistant</h2>
                            <p>Your intelligent web automation and research companion. Choose a mode and start your conversation.</p>
                            <div class="welcome-features">
                                <div class="feature">
                                    <i class="fas fa-globe"></i>
                                    <span>Web Navigation</span>
                                </div>
                                <div class="feature">
                                    <i class="fas fa-search"></i>
                                    <span>Research & Analysis</span>
                                </div>
                                <div class="feature">
                                    <i class="fas fa-cogs"></i>
                                    <span>Task Automation</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Input Container -->
                    <div class="input-container">
                        <div class="input-wrapper">
                            <textarea 
                                id="messageInput" 
                                placeholder="Type your message or describe a task..."
                                rows="1"
                            ></textarea>
                            <div class="input-actions">
                                <button class="action-btn-small" id="attachBtn">
                                    <i class="fas fa-paperclip"></i>
                                </button>
                                <button class="send-btn" id="sendBtn">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                        <div class="input-footer">
                            <span class="input-hint">Press Enter to send, Shift+Enter for new line</span>
                            <div class="typing-indicator" id="typingIndicator">
                                <div class="typing-dots">
                                    <span></span>
                                    <span></span>
                                    <span></span>
                                </div>
                                <span>Assistant is thinking...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Modals -->
    <div class="modal-overlay" id="modalOverlay">
        <!-- Image Modal -->
        <div class="modal" id="imageModal">
            <div class="modal-header">
                <h3>Screenshot</h3>
                <button class="modal-close" id="closeModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <img id="modalImage" src="" alt="Screenshot">
            </div>
        </div>

        <!-- Progress Details Modal -->
        <div class="modal" id="progressModal">
            <div class="modal-header">
                <h3>Task Progress Details</h3>
                <button class="modal-close" id="closeProgressModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="progress-details" id="progressDetails">
                    <!-- Progress details will be populated here -->
                </div>
            </div>
        </div>

        <!-- Result Preview Modal -->
        <div class="modal large" id="resultModal">
            <div class="modal-header">
                <h3>Task Result</h3>
                <div class="modal-actions">
                    <button class="btn-secondary" id="downloadResult">
                        <i class="fas fa-download"></i>
                        Download
                    </button>
                    <button class="modal-close" id="closeResultModal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="modal-content">
                <div class="result-content" id="resultContent">
                    <!-- Result content will be populated here -->
                </div>
            </div>
        </div>

        <!-- Screenshots Gallery Modal -->
        <div class="modal large" id="screenshotsModal">
            <div class="modal-header">
                <h3>Screenshots Gallery</h3>
                <button class="modal-close" id="closeScreenshotsModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="screenshots-gallery" id="screenshotsGallery">
                    <!-- Screenshots will be populated here -->
                </div>
            </div>
        </div>

        <!-- Export Modal -->
        <div class="modal" id="exportModal">
            <div class="modal-header">
                <h3>Export Conversation</h3>
                <button class="modal-close" id="closeExportModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="export-options">
                    <button class="export-btn" data-format="markdown">
                        <i class="fab fa-markdown"></i>
                        <span>Markdown</span>
                    </button>
                    <button class="export-btn" data-format="html">
                        <i class="fas fa-code"></i>
                        <span>HTML</span>
                    </button>
                    <button class="export-btn" data-format="json">
                        <i class="fas fa-file-code"></i>
                        <span>JSON</span>
                    </button>
                    <button class="export-btn" data-format="pdf">
                        <i class="fas fa-file-pdf"></i>
                        <span>PDF</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- File input for avatar change -->
    <input type="file" id="avatarInput" accept="image/*" style="display: none;">
    
    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js"></script>
    <!-- <script src="js/app.js"></script> -->

<script>
class MCPAssistant {
    constructor() {
        this.websocket = null;
        this.sessionId = null;
        this.currentConversationId = null;
        this.isConnected = false;
        this.isTaskRunning = false;
        this.currentUser = null;
        this.authToken = null;
        
        this.init();
    }

    init() {
        this.setupEventListeners();
        this.checkAuthentication();
        this.setupMarkdownRenderer();
    }

    setupEventListeners() {
        // Login form
        document.getElementById('loginForm').addEventListener('submit', (e) => {
            e.preventDefault();
            this.handleLogin();
        });

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', () => {
            this.logout();
        });

        // Sidebar toggle
        document.getElementById('sidebarToggle').addEventListener('click', () => {
            this.toggleSidebar();
        });

        // New chat button
        document.getElementById('newChatBtn').addEventListener('click', () => {
            this.createNewConversation();
        });

        // Send message
        document.getElementById('sendBtn').addEventListener('click', () => {
            if (this.isTaskRunning) {
                this.stopExecution();
            } else {
                this.sendMessage();
            }
        });

        // Message input
        const messageInput = document.getElementById('messageInput');
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (this.isTaskRunning) {
                    this.stopExecution();
                } else {
                    this.sendMessage();
                }
            }
        });

        // Auto-resize textarea
        messageInput.addEventListener('input', () => {
            this.autoResizeTextarea(messageInput);
        });

        // Mode selector
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                this.setMode(btn.dataset.mode);
            });
        });

        // Quick actions
        document.querySelectorAll('.action-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                this.executeQuickAction(btn.dataset.action);
            });
        });

        // Examples
        document.querySelectorAll('.example-item').forEach(item => {
            item.addEventListener('click', () => {
                this.useExample(item.dataset.example);
            });
        });

        // User menu
        document.getElementById('userAvatar').addEventListener('click', () => {
            this.toggleUserMenu();
        });

        // Change avatar
        document.getElementById('changeAvatar').addEventListener('click', () => {
            this.changeAvatar();
        });

        // Export data
        document.getElementById('exportData').addEventListener('click', () => {
            this.showExportModal();
        });

        // Progress details
        document.getElementById('progressDetailsBtn').addEventListener('click', () => {
            this.showProgressDetails();
        });

        // Modal close buttons
        document.querySelectorAll('.modal-close').forEach(btn => {
            btn.addEventListener('click', () => {
                this.closeModal(btn.closest('.modal').id);
            });
        });

        // Export buttons
        document.querySelectorAll('.export-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                this.exportConversation(btn.dataset.format);
            });
        });

        // Click outside to close modals and dropdowns
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.user-menu')) {
                this.closeUserMenu();
            }
            if (e.target.classList.contains('modal-overlay')) {
                this.closeAllModals();
            }
        });

        // Avatar file input
        document.getElementById('avatarInput').addEventListener('change', (e) => {
            this.handleAvatarChange(e);
        });
    }

    async checkAuthentication() {
        const token = localStorage.getItem('auth_token');
        if (!token) {
            this.showLogin();
            return;
        }

        try {
            const response = await fetch('/auth/me', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                const user = await response.json();
                this.currentUser = user;
                this.authToken = token;
                this.showApp();
                this.loadConversations();
                this.loadApiLimits();
                this.connectWebSocket();
            } else {
                localStorage.removeItem('auth_token');
                this.showLogin();
            }
        } catch (error) {
            console.error('Authentication check failed:', error);
            this.showLogin();
        }
    }

    async handleLogin() {
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        const errorDiv = document.getElementById('loginError');

        try {
            const response = await fetch('/auth/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ username, password })
            });

            if (response.ok) {
                const data = await response.json();
                localStorage.setItem('auth_token', data.access_token);
                this.currentUser = data.user;
                this.authToken = data.access_token;
                this.showApp();
                this.loadConversations();
                this.loadApiLimits();
                this.connectWebSocket();
            } else {
                const error = await response.json();
                errorDiv.textContent = error.detail || 'Login failed';
                errorDiv.style.display = 'block';
            }
        } catch (error) {
            console.error('Login error:', error);
            errorDiv.textContent = 'Connection error. Please try again.';
            errorDiv.style.display = 'block';
        }
    }

    logout() {
        localStorage.removeItem('auth_token');
        this.currentUser = null;
        this.authToken = null;
        if (this.websocket) {
            this.websocket.close();
        }
        this.showLogin();
    }

    showLogin() {
        document.getElementById('loginContainer').style.display = 'flex';
        document.getElementById('appContainer').style.display = 'none';
    }

    showApp() {
        document.getElementById('loginContainer').style.display = 'none';
        document.getElementById('appContainer').style.display = 'flex';
        
        // Update user info
        if (this.currentUser) {
            document.getElementById('username').textContent = this.currentUser.username;
            document.getElementById('avatarImg').src = this.currentUser.avatar;
            document.getElementById('dropdownAvatar').src = this.currentUser.avatar;
        }
    }

    connectWebSocket() {
        this.sessionId = this.generateSessionId();
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/${this.sessionId}`;

        this.websocket = new WebSocket(wsUrl);

        this.websocket.onopen = () => {
            this.isConnected = true;
            this.updateConnectionStatus('Connected', 'connected');
        };

        this.websocket.onmessage = (event) => {
            const message = JSON.parse(event.data);
            this.handleWebSocketMessage(message);
        };

        this.websocket.onclose = () => {
            this.isConnected = false;
            this.updateConnectionStatus('Disconnected', 'disconnected');
            
            // Attempt to reconnect after 3 seconds
            setTimeout(() => {
                if (!this.isConnected) {
                    this.connectWebSocket();
                }
            }, 3000);
        };

        this.websocket.onerror = (error) => {
            console.error('WebSocket error:', error);
            this.updateConnectionStatus('Error', 'error');
        };
    }

    handleWebSocketMessage(message) {
        switch (message.type) {
            case 'progress_update':
                this.updateProgress(message);
                break;
            case 'progress_complete':
                this.hideProgress();
                this.setTaskRunning(false);
                break;
            case 'assistant_message':
                this.addMessage('assistant', message.message, message);
                if (message.final) {
                    this.setTaskRunning(false);
                }
                break;
            case 'user_message':
                this.addMessage('user', message.message, message);
                break;
            case 'tool_executing':
                this.showToolExecution(message);
                break;
            case 'tool_success':
            case 'tool_success_image':
                this.showToolResult(message);
                break;
            case 'tool_error':
                this.showToolError(message);
                break;
            case 'task_started':
                this.setTaskRunning(true);
                this.showProgress('Starting task...', 0);
                break;
            case 'task_completed':
                this.hideProgress();
                this.setTaskRunning(false);
                if (message.final) {
                    this.addMessage('assistant', message.message, message);
                }
                break;
            case 'screenshots_summary':
                this.showScreenshotsSummary(message.screenshots);
                break;
            case 'execution_stopped':
                this.hideProgress();
                this.setTaskRunning(false);
                this.addMessage('system', message.message, message);
                break;
            case 'error':
                this.showError(message.message);
                this.setTaskRunning(false);
                break;
        }
    }

    async loadConversations() {
        try {
            const response = await fetch('/conversations', {
                headers: {
                    'Authorization': `Bearer ${this.authToken}`
                }
            });

            if (response.ok) {
                const data = await response.json();
                this.renderConversations(data.conversations);
            }
        } catch (error) {
            console.error('Failed to load conversations:', error);
        }
    }

    async loadApiLimits() {
        try {
            const response = await fetch('/api/limits', {
                headers: {
                    'Authorization': `Bearer ${this.authToken}`
                }
            });

            if (response.ok) {
                const data = await response.json();
                document.getElementById('remainingCalls').textContent = `${data.remaining_calls} calls remaining`;
            }
        } catch (error) {
            console.error('Failed to load API limits:', error);
        }
    }

    renderConversations(conversations) {
        const container = document.getElementById('conversationsList');
        container.innerHTML = '';

        conversations.forEach(conv => {
            const item = document.createElement('div');
            item.className = 'conversation-item';
            item.dataset.conversationId = conv.id;
            
            item.innerHTML = `
                <div class="conversation-title">${conv.title}</div>
                <div class="conversation-date">${new Date(conv.updated_at).toLocaleDateString()}</div>
            `;

            item.addEventListener('click', () => {
                this.loadConversation(conv.id);
            });

            container.appendChild(item);
        });
    }

    async createNewConversation() {
        try {
            const response = await fetch('/conversations', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${this.authToken}`
                },
                body: JSON.stringify({
                    title: `New Conversation ${new Date().toLocaleDateString()}`
                })
            });

            if (response.ok) {
                const conversation = await response.json();
                this.currentConversationId = conversation.id;
                this.clearMessages();
                this.loadConversations();
                this.updateChatTitle(conversation.title);
            }
        } catch (error) {
            console.error('Failed to create conversation:', error);
        }
    }

    async loadConversation(conversationId) {
        try {
            const response = await fetch(`/conversations/${conversationId}`, {
                headers: {
                    'Authorization': `Bearer ${this.authToken}`
                }
            });

            if (response.ok) {
                const conversation = await response.json();
                this.currentConversationId = conversationId;
                this.clearMessages();
                this.updateChatTitle(conversation.title);
                
                // Load messages
                conversation.messages.forEach(msg => {
                    this.addMessage(msg.role, msg.content, { conversation_id: conversationId });
                });

                // Update active conversation
                document.querySelectorAll('.conversation-item').forEach(item => {
                    item.classList.remove('active');
                });
                document.querySelector(`[data-conversation-id="${conversationId}"]`)?.classList.add('active');
            }
        } catch (error) {
            console.error('Failed to load conversation:', error);
        }
    }

    sendMessage() {
        const input = document.getElementById('messageInput');
        const message = input.value.trim();

        if (!message || !this.isConnected) return;

        // Add user message to UI
        this.addMessage('user', message);
        input.value = '';
        this.autoResizeTextarea(input);

        // Send to WebSocket
        const messageData = {
            type: this.getCurrentMode() === 'task' ? 'task' : 'chat',
            message: message,
            conversation_id: this.currentConversationId
        };

        this.websocket.send(JSON.stringify(messageData));
        this.setTaskRunning(true);
        this.showProgress('Processing your request...', 10);
    }

    stopExecution() {
        if (this.websocket && this.isTaskRunning) {
            this.websocket.send(JSON.stringify({
                type: 'stop_execution'
            }));
        }
    }

    setTaskRunning(isRunning) {
        this.isTaskRunning = isRunning;
        const sendBtn = document.getElementById('sendBtn');
        
        if (isRunning) {
            sendBtn.classList.add('stop');
            sendBtn.innerHTML = '<i class="fas fa-stop"></i>';
            sendBtn.title = 'Stop execution';
        } else {
            sendBtn.classList.remove('stop');
            sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
            sendBtn.title = 'Send message';
        }
    }

    addMessage(role, content, metadata = {}) {
        const container = document.getElementById('messagesContainer');
        const welcomeMessage = document.getElementById('welcomeMessage');
        
        if (welcomeMessage) {
            welcomeMessage.style.display = 'none';
        }

        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${role}`;
        
        const avatarIcon = role === 'user' ? 'U' : 
                          role === 'assistant' ? 'A' : 'S';
        
        const timestamp = new Date().toLocaleTimeString();
        
        // Process content based on type
        let processedContent = content;
        if (typeof content === 'string') {
            processedContent = this.renderMarkdown(content);
        }

        messageDiv.innerHTML = `
            <div class="message-header">
                <div class="message-avatar">${avatarIcon}</div>
                <div class="message-info">
                    <div class="message-sender">${role.charAt(0).toUpperCase() + role.slice(1)}</div>
                    <div class="message-time">${timestamp}</div>
                </div>
            </div>
            <div class="message-content">
                ${this.createResultPreview(processedContent)}
                ${this.createMessageActions(role, content, metadata)}
            </div>
        `;

        container.appendChild(messageDiv);
        container.scrollTop = container.scrollHeight;
    }

    createResultPreview(content) {
        const maxLength = 1000;
        if (content.length > maxLength) {
            return `
                <div class="result-preview truncated">
                    ${content.substring(0, maxLength)}...
                </div>
                <button class="show-more-btn" onclick="mcpAssistant.showFullResult('${btoa(content)}')">
                    <i class="fas fa-expand-alt"></i> Show Full Result
                </button>
            `;
        }
        return content;
    }

    createMessageActions(role, content, metadata) {
        if (role === 'assistant') {
            return `
                <div class="message-actions">
                    <button class="message-action" onclick="mcpAssistant.copyToClipboard('${btoa(content)}')">
                        <i class="fas fa-copy"></i> Copy
                    </button>
                    <button class="message-action" onclick="mcpAssistant.downloadContent('${btoa(content)}', 'result.md')">
                        <i class="fas fa-download"></i> Download
                    </button>
                </div>
            `;
        }
        return '';
    }

    showFullResult(encodedContent) {
        const content = atob(encodedContent);
        const modal = document.getElementById('resultModal');
        const contentDiv = document.getElementById('resultContent');
        
        contentDiv.innerHTML = this.renderMarkdown(content);
        this.showModal('resultModal');
        
        // Setup download button
        document.getElementById('downloadResult').onclick = () => {
            this.downloadContent(encodedContent, 'full_result.md');
        };
    }

    copyToClipboard(encodedContent) {
        const content = atob(encodedContent);
        navigator.clipboard.writeText(content).then(() => {
            this.showNotification('Content copied to clipboard!', 'success');
        }).catch(err => {
            console.error('Failed to copy:', err);
            this.showNotification('Failed to copy content', 'error');
        });
    }

    downloadContent(encodedContent, filename) {
        const content = atob(encodedContent);
        const blob = new Blob([content], { type: 'text/markdown' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    showProgress(message, progress) {
        const container = document.getElementById('progressContainer');
        const fill = document.getElementById('progressFill');
        const messageSpan = document.getElementById('progressMessage');
        
        container.style.display = 'block';
        fill.style.width = `${progress}%`;
        messageSpan.textContent = message;
    }

    updateProgress(data) {
        this.showProgress(data.message, data.progress || 0);
    }

    hideProgress() {
        document.getElementById('progressContainer').style.display = 'none';
    }

    showToolExecution(data) {
        const container = document.getElementById('messagesContainer');
        const toolDiv = document.createElement('div');
        toolDiv.className = 'tool-indicator executing';
        toolDiv.innerHTML = `
            <i class="fas fa-cog"></i>
            <span>Executing ${data.tool_name}...</span>
        `;
        container.appendChild(toolDiv);
        container.scrollTop = container.scrollHeight;
    }

    showToolResult(data) {
        const indicators = document.querySelectorAll('.tool-indicator.executing');
        const lastIndicator = indicators[indicators.length - 1];
        
        if (lastIndicator) {
            lastIndicator.className = 'tool-indicator success';
            lastIndicator.innerHTML = `
                <i class="fas fa-check"></i>
                <span>${data.message}</span>
            `;
        }
    }

    showToolError(data) {
        const indicators = document.querySelectorAll('.tool-indicator.executing');
        const lastIndicator = indicators[indicators.length - 1];
        
        if (lastIndicator) {
            lastIndicator.className = 'tool-indicator error';
            lastIndicator.innerHTML = `
                <i class="fas fa-exclamation-triangle"></i>
                <span>${data.message}</span>
            `;
        }
    }

    showScreenshotsSummary(screenshots) {
        if (screenshots.length === 0) return;

        const container = document.getElementById('messagesContainer');
        const summaryDiv = document.createElement('div');
        summaryDiv.className = 'screenshots-summary';
        
        summaryDiv.innerHTML = `
            <h4><i class="fas fa-images"></i> Screenshots Captured (${screenshots.length})</h4>
            <div class="screenshots-grid">
                ${screenshots.map(screenshot => `
                    <div class="screenshot-thumb" onclick="mcpAssistant.showScreenshot('${screenshot.path}')">
                        <img src="${screenshot.path}" alt="${screenshot.filename}" loading="lazy">
                    </div>
                `).join('')}
            </div>
            <button class="btn-secondary" onclick="mcpAssistant.showScreenshotsGallery(${JSON.stringify(screenshots).replace(/"/g, '&quot;')})">
                <i class="fas fa-expand"></i> View All Screenshots
            </button>
        `;

        container.appendChild(summaryDiv);
        container.scrollTop = container.scrollHeight;
    }

    showScreenshot(path) {
        const modal = document.getElementById('imageModal');
        const img = document.getElementById('modalImage');
        img.src = path;
        this.showModal('imageModal');
    }

    showScreenshotsGallery(screenshots) {
        const modal = document.getElementById('screenshotsModal');
        const gallery = document.getElementById('screenshotsGallery');
        
        gallery.innerHTML = screenshots.map(screenshot => `
            <div class="screenshot-item">
                <img src="${screenshot.path}" alt="${screenshot.filename}" onclick="mcpAssistant.showScreenshot('${screenshot.path}')">
                <div class="screenshot-info">
                    <div class="screenshot-name">${screenshot.filename}</div>
                    <div class="screenshot-date">${new Date(screenshot.created_at).toLocaleString()}</div>
                </div>
            </div>
        `).join('');
        
        this.showModal('screenshotsModal');
    }

    showError(message) {
        this.showNotification(message, 'error');
    }

    showNotification(message, type = 'info') {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'exclamation-triangle' : 'info-circle'}"></i>
            <span>${message}</span>
        `;
        
        document.body.appendChild(notification);
        
        // Auto remove after 3 seconds
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }

    toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        sidebar.classList.toggle('collapsed');
        
        // On mobile, use show/hide instead of collapsed
        if (window.innerWidth <= 768) {
            sidebar.classList.toggle('show');
        }
    }

    toggleUserMenu() {
        const dropdown = document.getElementById('userDropdown');
        dropdown.classList.toggle('show');
    }

    closeUserMenu() {
        document.getElementById('userDropdown').classList.remove('show');
    }

    changeAvatar() {
        document.getElementById('avatarInput').click();
        this.closeUserMenu();
    }

    handleAvatarChange(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const newAvatarUrl = e.target.result;
                document.getElementById('avatarImg').src = newAvatarUrl;
                document.getElementById('dropdownAvatar').src = newAvatarUrl;
                
                // In a real app, you would upload this to the server
                this.showNotification('Avatar updated successfully!', 'success');
            };
            reader.readAsDataURL(file);
        }
    }

    setMode(mode) {
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector(`[data-mode="${mode}"]`).classList.add('active');
        
        // Update placeholder text
        const input = document.getElementById('messageInput');
        if (mode === 'task') {
            input.placeholder = 'Describe a task to automate...';
        } else {
            input.placeholder = 'Type your message...';
        }
    }

    getCurrentMode() {
        const activeBtn = document.querySelector('.mode-btn.active');
        return activeBtn ? activeBtn.dataset.mode : 'chat';
    }

    executeQuickAction(action) {
        const actions = {
            screenshot: 'Take a screenshot of the current page',
            navigate: 'Navigate to a website and analyze its content',
            research: 'Research a topic and provide a comprehensive analysis',
            analyze: 'Analyze the current page content and provide insights'
        };
        
        const message = actions[action];
        if (message) {
            document.getElementById('messageInput').value = message;
            this.sendMessage();
        }
    }

    useExample(example) {
        document.getElementById('messageInput').value = example;
        document.getElementById('messageInput').focus();
    }

    showExportModal() {
        this.showModal('exportModal');
        this.closeUserMenu();
    }

    async exportConversation(format) {
        if (!this.currentConversationId) {
            this.showNotification('No conversation selected', 'error');
            return;
        }

        try {
            const response = await fetch(`/conversations/${this.currentConversationId}/export/${format}`, {
                headers: {
                    'Authorization': `Bearer ${this.authToken}`
                }
            });

            if (response.ok) {
                const data = await response.json();
                this.downloadContent(btoa(data.content), data.filename);
                this.closeModal('exportModal');
                this.showNotification('Export completed successfully!', 'success');
            } else {
                this.showNotification('Export failed', 'error');
            }
        } catch (error) {
            console.error('Export error:', error);
            this.showNotification('Export failed', 'error');
        }
    }

    showProgressDetails() {
        this.showModal('progressModal');
        // Populate with current progress details
        document.getElementById('progressDetails').innerHTML = `
            <div class="progress-step">
                <i class="fas fa-check-circle"></i>
                <span>Connection established</span>
            </div>
            <div class="progress-step active">
                <i class="fas fa-spinner fa-spin"></i>
                <span>Processing request...</span>
            </div>
            <div class="progress-step">
                <i class="fas fa-circle"></i>
                <span>Generating response</span>
            </div>
        `;
    }

    showModal(modalId) {
        document.getElementById('modalOverlay').classList.add('show');
        document.querySelectorAll('.modal').forEach(modal => {
            modal.style.display = modal.id === modalId ? 'flex' : 'none';
        });
    }

    closeModal(modalId) {
        if (modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        document.getElementById('modalOverlay').classList.remove('show');
    }

    closeAllModals() {
        document.getElementById('modalOverlay').classList.remove('show');
        document.querySelectorAll('.modal').forEach(modal => {
            modal.style.display = 'none';
        });
    }

    clearMessages() {
        const container = document.getElementById('messagesContainer');
        container.innerHTML = '<div class="welcome-message" id="welcomeMessage" style="display: block;">...</div>';
    }

    updateChatTitle(title) {
        document.getElementById('chatTitle').textContent = title;
    }

    updateConnectionStatus(status, type) {
        const statusElement = document.getElementById('connectionStatus');
        const dot = statusElement.querySelector('.status-dot');
        const text = statusElement.querySelector('span');
        
        text.textContent = status;
        dot.className = `status-dot ${type}`;
    }

    autoResizeTextarea(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
    }

    setupMarkdownRenderer() {
        // Configure marked for better markdown rendering
        if (typeof marked !== 'undefined') {
            marked.setOptions({
                breaks: true,
                gfm: true,
                sanitize: false
            });
        }
    }

    renderMarkdown(content) {
        if (typeof marked !== 'undefined') {
            return marked.parse(content);
        }
        
        // Fallback basic markdown rendering
        return content
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            .replace(/`(.*?)`/g, '<code>$1</code>')
            .replace(/\n/g, '<br>');
    }

    generateSessionId() {
        return 'session_' + Math.random().toString(36).substr(2, 9);
    }
}

// Initialize the application
const mcpAssistant = new MCPAssistant();

// Add notification styles
const notificationStyles = `
    .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 16px;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        z-index: 3000;
        display: flex;
        align-items: center;
        gap: 8px;
        animation: slideInRight 0.3s ease-out;
        max-width: 400px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .notification.success {
        background: var(--success-color);
    }
    
    .notification.error {
        background: var(--error-color);
    }
    
    .notification.info {
        background: var(--primary-color);
    }
    
    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    .progress-step {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 8px 0;
        color: var(--text-secondary);
    }
    
    .progress-step.active {
        color: var(--primary-color);
        font-weight: 500;
    }
    
    .progress-step i {
        width: 16px;
        text-align: center;
    }
    
    .screenshot-item {
        margin-bottom: 16px;
        border: 1px solid var(--border);
        border-radius: var(--border-radius);
        overflow: hidden;
    }
    
    .screenshot-item img {
        width: 100%;
        height: auto;
        cursor: pointer;
        transition: var(--transition);
    }
    
    .screenshot-item img:hover {
        transform: scale(1.02);
    }
    
    .screenshot-info {
        padding: 12px;
        background: var(--surface-hover);
    }
    
    .screenshot-name {
        font-weight: 500;
        margin-bottom: 4px;
    }
    
    .screenshot-date {
        font-size: 12px;
        color: var(--text-muted);
    }
`;

// Inject notification styles
const styleSheet = document.createElement('style');
styleSheet.textContent = notificationStyles;
document.head.appendChild(styleSheet);
</script>
</body>
</html>